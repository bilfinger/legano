'use strict';var cfg=require('./package').config;var port=process.env.OPENSHIFT_NODEJS_PORT||cfg.webport;var ipaddress=process.env.OPENSHIFT_NODEJS_IP||'*';var http=require('http');var fs=require('fs');var dgram=require('dgram');var router=require(cfg.path+'swnode/swRouter');var slog=cfg.log?require(cfg.path+'swnode/swLogStream')('./log/server.log'):undefined;var mud=require(cfg.path+'swnode/modbus_udp');var esfm=require('./esfm');var cb=function cb(e){return env=e};var sb=function sb(e){return sub=e};var memcache={};var env={};var sub={subscribers:[],subactive:false};var esm=[{ev:'add',cb:esfm.post},{ev:'badd',cb:esfm.post},{ev:'delete',cb:esfm.delete},{ev:'keep',cb:esfm.keep},{ev:'update',cb:esfm.put}];console.log('VERSUCH parametrierter Funktionen---',0,Function.apply(null,cfg.sfunc)({x:0},{x:0}));console.log('VERSUCH parametrierter Funktionen---',0,Function.apply(null,cfg.sfunc)({x:1},{x:1}));console.log('VERSUCH parametrierter Funktionen---',1,Function.apply(null,cfg.sfunc)({x:1},{x:0}));console.log('VERSUCH parametrierter Funktionen---',1,Function.apply(null,cfg.sfunc)({x:0,z:1},{x:1,y:0}));console.log('VERSUCH parametrierter Funktionen---',1,Function.apply(null,cfg.sfunc)({x:1,y:0,z:0},{x:1,y:0,z:1}));http.createServer(function(req,res){return router(req,res,slog,cb,env,memcache,esfm.keep,cfg.table,sb,sub,esm)}).listen(port,ipaddress,function(){console.log('SERVER listen on porti '+cfg.host+':'+cfg.webport+':'+cfg.data+'/'+cfg.table+' ...')});fs.readFile(cfg.data,function(err,data){if(err)throw err;env=JSON.parse(data);env['_all']=cfg.tabs;env[cfg.table].forEach(function(e,i){console.log('startet with',cfg.simulation,e.ip,e.plant,e.station)})});setInterval(function(){fs.writeFile(cfg.data,JSON.stringify(env,null,2),function(err){if(err)throw err})},36000);fs.readdir('./app',function(r,d){return d.forEach(function(e){return fs.readFile('./app/'+e,function(err,data){if(err)throw err;memcache['/'+e]=data;console.log(e,' loaded..',data.length)})})});if(!cfg.simulation){(function(){var dsocket=dgram.createSocket('udp4');dsocket.bind(cfg.udpport);dsocket.on('error',function(err){console.log('SERVER-ERROR',err.stack);dsocket.close();ERRLOG.write(Date.now()+'SERVER-ERROR '+err.stack)});dsocket.on('listening',function(){var _adr=dsocket.address();console.log('%s:%d module-server listening.. ',_adr.address,_adr.port)});dsocket.on('message',function(msg,rinfo){try{var _j=JSON.parse(msg)}catch(e){console.log('ERROR-JSON-PARSE DSOCKET MESSAGE',e)}console.log('DSOCKET MESSAGE ',Date.now(),msg.length,rinfo.address,rinfo.port,_j.device,_j.unit,_j.key,_j.value);var field='',elem=Array.prototype.filter.call(env[cfg.table],function(e){return e.station===_j.device});if(elem.length>0){if(_j.key==='Teilio')field='teilio';if(_j.key==='Teilnio')field='teilnio';if(_j.key==='Status')field='lstatus';if(_j.key==='TaktIst')field='taktist';if(_j.key==='Status')field='lstatus';monats_wechsel(elem[0]);if(_j.key==='Teilio'&&parseInt(_j.value)===0)elem[0]['strigger']=1;schicht_wechsel(elem[0]);elem_update(elem[0],{key:_j.key,value:_j.value,field:field},esfm,sub,cfg.table,false);require(cfg.path+'swnode/swsendUDP')(JSON.stringify(_j),cfg.splkhost,cfg.splkport)}})})()}var monats_wechsel=function monats_wechsel(elem){if(elem['mtrigger']){elem['mtrigger']=0;elem['hteilio']=[];elem['hteilnio']=[];elem['hteilabs']=[];elem['hteilabsp']=[];elem['hstimes']=[]}};var schicht_wechsel=function schicht_wechsel(elem){if(elem['strigger']){var oldteilio=elem['teilio'];var oldteilnio=elem['teilnio'];var schichtsoll=elem['teilesoll'];var oldstatus=elem['lstatus'];var lnow=Date.now();console.log('TRIGGER',oldteilio);elem['strigger']=0;elem['stimes'][oldstatus]=(elem['stimes'][oldstatus]||0)+(lnow-elem['sdat'])/60000;elem['sdat']=lnow;elem['hteilio'].push(oldteilio);if(elem['hteilio'].length>100)elem['hteilio'].shift();elem['hteilnio'].push(oldteilnio);if(elem['hteilnio'].length>100)elem['hteilnio'].shift();elem['hteilabs'].push(oldteilio-schichtsoll);if(elem['hteilabs'].length>100)elem['hteilabs'].shift();elem['hteilabsp'].push((oldteilio-schichtsoll)/schichtsoll);if(elem['hteilabsp'].length>100)elem['hteilabsp'].shift();elem['stimes'].forEach(function(e,i){return elem['hstimes'][i]=(elem['hstimes'][i]||0)+parseInt(e||0)});elem['stimes']=[];elem['teilio']=0;elem['teilnio']=0;elem['schichtdat']=Date.now()}};var elem_update=function elem_update(elem,kvk,xesf,xsub,xtable,simulation){console.log('ELEM_UPDATE:',kvk.key,kvk.field,kvk.value||'simulation');var lnow=Date.now();switch(kvk.key){case 'Teilio':var oldteilio=elem[kvk.field];var newteilio=simulation?oldteilio+1:kvk.value;elem[kvk.field]=newteilio;break;case 'Teilnio':elem[kvk.field]=simulation?parseInt(elem[kvk.field])+1:kvk.value;break;case 'TaktIst':elem[kvk.field]=simulation?parseInt(elem[kvk.field])+1:kvk.value;break;case 'Status':var newstatus='0123456'.charAt(parseInt(Math.random()*7));var oldstatus=elem[kvk.field];elem[kvk.field]=simulation?newstatus:kvk.value;elem['stimes'][oldstatus]=(elem['stimes'][oldstatus]||0)+(lnow-elem['sdat'])/60000;elem['sdat']=lnow;break;}elem['adat']=lnow;elem['addat']=new Date(lnow).toISOString();xesf.put(xsub,xtable,elem._id,elem)};var kv=[{key:'Status',field:'lstatus'},{key:'Teilio',field:'teilio'},{key:'Teilnio',field:'teilnio'},{key:'TaktIst',field:'taktist'},{key:'ENERGY',field:'energy'}];var simulation=function simulation(xsub,xtable,xenv,xesf,xkv){var j=parseInt(Math.random()*xenv[xtable].length);var k=parseInt(Math.random()*xkv.length);var lnow=Date.now();var elem=Array.prototype.filter.call(xenv[xtable],function(e,i,a){return i===j});if(elem.length>0){monats_wechsel(elem[0]);schicht_wechsel(elem[0]);elem_update(elem[0],xkv[k],xesf,xsub,xtable,true)}};if(cfg.simulation)setInterval(function(){return simulation(sub,cfg.table,env,esfm,kv)},5000);
